<!DOCTYPE html>
<html>

<head>
    <title>Solubility Predictor</title>
    <style>
        * {
            font-family: 'arial';
            font-size: 20px;
        }
    </style>

    <script>
        //This script is to show the two different pages
        function show(shown, hidden) {
            document.getElementById(shown).style.display = 'block';
            document.getElementById(hidden).style.display = 'none';
            return false;
        }
    </script>

</head>


<body>
    <div id='title' align='center'> Summer Intern Project: Brandon Gonzalez</div>
    
    <div id="Page1">
        <a href="#" onclick="return show('Page2','Page1');">Show page 2 </a>

        <div id='main' align='left'>
            <h2 align='left' >Solubility in Water</h2>
            <input id="file-selector" type="file" name="files" multiple> 
            
            <h2>Single SMILES: 
            <input id="single-mol" type="text" align='right' />
            </h2>
            
            <div id='buttons'>
                <input type="radio" id='rC' name="molInput" algin='left'> CSV file
                <br>
                <input type="radio" id="rS" name="molInput" align='right'> Single Molecule via SMILES
                <br>
            </div>
            <button id="predict-button" allign='center'style='color:#56657'>Predict</button>
           
        </div>
        <div id="loadDiv" align="center" style.display="none"> Loading <progress id="loadBar" value="0" align='center'></progress></div>

            <div class="container" align='middle'>
                <canvas id="row-chart-s" width="900" height="450"></canvas>                
                <table id="chartS" class='row-border hover' style='width:70%'></table>
            </div>
    </div>


    
    <div id="Page2">
        <a href="#" onclick="return show('Page1','Page2');">Back to Page 1</a>
        <div>
            <h2>Solubility of a Molecule in Different Excipients</h2>
            <p>SMILE:</p>
            <input id="single-mol-E" type="text" align='right' />
            <button id="predict-E" allign='center'>Predict</button>
            <div class="container" align='middle'>
                <canvas id="row-chart-e"></canvas>
                <table id="chartE" class='row-border hover' style='width:75%'></table>
            </div>
        </div>
    </div>
    

    <div id='pubchemsketch', align='center' style='color:#3498DB'>
        <h1 align='center'>PubChemSketch:</h1>
        <iframe src="https://pubchem.ncbi.nlm.nih.gov/edit2/index.html" align='center' height="500" width="900" style="border:none;"></iframe>
    </div>


    <link href="style.css" rel="stylesheet" type="text/css" />
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css"></link>
    <script type="text/javascript" src="//cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>

    <text id="selected molecule" src=""/>

    <script>
        document.getElementById("Page2").style.display = 'none';
        var molecules = [];
        let input = []
        var loadBar = document.getElementById("loadDiv").style.display="none";
       
        function findMgPerMl(logS, molWt) {
            //raise log s predicted value to its base of 10 to get mol/L. Then divide by 1000 to get mol/ml
            var InvLogS = Math.pow(logS, 10) // /1000;
            //multiply mol/ml by molecular weight to get g/ml. Then multiply by 1000 to get mg/ml. 
            var s = InvLogS * molWt;
            return s.toFixed(4);
        }


        $("#file-selector").change(function (event) {
            molecules = [];
            let names =[]
            for (var i = 0; i < ($("#file-selector")[0].files.length); i++) {
                let text = "";
                var reader = new FileReader();
                console.log($("#file-selector")[0].files.length);
                reader.readAsText($("#file-selector")[0].files[i]);
                reader.onload = function (e) {
                    text = reader.result;
                    //get the read results and split it based on new line and then commas, store into list
                    list = text.split(/\n/).join(',').split(',');
                    console.log(list);
                    //add the split list into the global molecules list
                    for (var index = 0; index < list.length; index++) {
                        if (list[index] != '') {
                            molecules.push(list[index]);
                            names.push(list[index]);
                        }
                    }
                }
            }
            input = molecules;
        });
        
            var request = 0;

            $("#predict-button").click(function (event) {
                var loadBar = document.getElementById("loadBar");
                loadBar.style.display="block";
                loadBar.value='100';
                loadDiv = document.getElementById("loadDiv");
                loadDiv.style.display="block"

                let message = {}
                //check to make sure an option is selected from the two radial buttons
                if (document.getElementById('rC').checked || document.getElementById('rS').checked) {
                    //check if csv option
                    if (document.getElementById('rC').checked) {
                        molecules = input
                        message = {
                            mol: molecules
                        }
                    }
                    else { //single smile option set the message to contain the single smile
                        molecules = [document.getElementById('single-mol').value];
                        message = {
                            mol: molecules
                        }
                    }
                    console.log(message);
                    var request = 0;
                    
                    /*THIS IS FOR SOLUBILITY IN WATER PAGE
                    */

                    //post the message to the flask app 
                    $.post("http://127.0.0.1:5000/predict", JSON.stringify(message), function (response) {
                        let predictions = Object.entries(response.prediction).map(function (entry) {
                            return {
                                category: [Array(molecules.length).keys()],
                                value: entry
                            };
                        });
                        //$("#solubility-prediction").text(response.prediction);
                        console.log(response)
                        //var solubilityChart = dc.barChart('#row-chart-s');

                        /*
                        -solubilities is an  array with the solubilites from the response
                        extract the value from the response using element[0] since solubility is in a nested array
                        
                        -indexes array will be passed into chart to
                        label the solubility to the molecule in order that it was passed
                        from the csv file
                        gives the x domain
                        
                        **/
                        var solubilitiesAndIndexes = [];
                        var solubilities = [];
                        var indexes = [solubilities.length];
                        var i = 0;
                        var weights = response['weight'];
                        var IUPACResponse = response['name'];
                        console.log(IUPACResponse);
                        var IUPACNames = [];
                        response.prediction.forEach(function (element) {

                            //get the molecular weight sent back from the flask app
                            var weight = weights[i];
                            
                            //push the response from pubchem(or not known) to the array for names
                            IUPACNames.push(IUPACResponse[i])

                            //get the solubility using the molWt and the predictes logS
                            solubility = findMgPerMl(element[0], weight);
                            
                            //store the solubility in the solubilities array. Will be used for chart from chartjs
                            solubilities.push(solubility);
    
                            //set indexes array
                            indexes[i] = ++i;

                            //this will be used for the dataTable                      
                            toAdd = [i, solubility,IUPACResponse[i-1]];
                            solubilitiesAndIndexes.push(toAdd);

                        });
                        //get rid of loading bar
                        loadBar.style.display="none";
                        loadDiv.style.display="none";
                        //make a chartjs barchart for the general solubilities (PAGE 1 CHART)
                        let solChart = document.getElementById('row-chart-s').getContext('2d');
                        var solubiltyChart = new Chart(solChart, {
                            type: 'bar',
                            data: {
                                labels: IUPACNames,
                                datasets: [{
                                    label: 'Solubility mg/mL',
                                    data: solubilities,
                                    backgroundColor: '#3498DB',
                                    borderWidth: 1.5,
                                    hoverBorderWidth: 3,
                                    hoverBorderColor: '#4b6584'
                                }]
                            },
                            options: {
                                title: {
                                    display: true,
                                    text: 'Solubility',
                                    fontSize: 25,
                                    backgroundColor:'#566573',
                                },
                                scales: {
                                    yAxes: [{
                                        ticks: {
                                            beginAtZero: true,
                                        },
                                        gridLines:{
                                            display:true,
                                        }
                                    }],
                                    xAxes:[{
                                        ticks:{
                                            display:true,
                                        },

                                        gridLines:{
                                            display:false
                                        }
                                    }]
                                },
                                /*    
                                tooltips: {
                                    afterTitle: function (tooltipItem, data) {
                                        return IUPACNames[tootipItems.datasetIndex];
                                    }
                                },*/
                            }
                        });
                        var table;
                        //set up the table with solubilities
                        if($.fn.dataTable.isDataTable('#chartS')){
                            table = $('#chartS').DataTable();
                            table.destroy();
                            $('#chartS').DataTable({
                                data: solubilitiesAndIndexes,
                                columns: [
                                    { title: "Index" },
                                    { title: "Solubility" },
                                    { title: 'IUPAC Name' },
                                ]
                            });
                        }
                        else{
                            table = $('#chartS').DataTable({
                                    data: solubilitiesAndIndexes,
                                    columns: [
                                        { title: "Index" },
                                        { title: "Solubility" },
                                        { title: 'IUPAC Name' },
                                    ]
                            });
                        }
                    });

                    request = 1;
                }
                else {
                    window.alert("Check option for CSV or single SMILE input!");
                }
            });

            /* This will be used for the second page, the excipient solubility 
            *  prediciton, activated when the predict button is pressed
            */
            $("#predict-E").click(function (event) {

                //Hard coded the excipients used in very early stage fromulation
                let excipients = ['Water', '0.1N Hydrochloric Acid in Water',
                    '0.1N Sodium Hydroxide in Water', '20mM Citrate in Water, pH4',
                    '20mM Phosphate in Water, pH8', '5% Dextrose in Water (DSW)',
                    '0.9% Sodium Chloride in Water', '40% Hydroxypropyl-B-Cyclodextrin(HPBCD) in Water',
                    '40% Sulfobutylether-B-Cyclodextrin (SBECD) in Water',
                    '1% Polysorbate 20 in Water', '1% Polysorbate 80 in water',
                    '1% Lutrol F68 in Water', '1% Kolliphor HS15 (Solutol HS15) in Water',
                    'filler', '10% Kolliphor HS15 (Solutol HS15) in Water',
                    '10% Kolliphor EL (Cremphor EL) in Water', 'Transcutol HP',
                    'Pharmasolve (NMP)', 'Dimethylacetamide (DMA)', 'Ethanol (EtOH)',
                    'Propylene Glycol (PG)', 'Polyethylene Glycol 300 (PEG 300)',
                    'Polyethylene Glycol 400 (PEG 400)'
                ];
                //console.log(excipients.length);

                /*get the single molecult to be predicted. add an E to the first position to let the flask service
               know to use the excipient model.
               */
                let molecules = ["E", document.getElementById('single-mol-E').value];
                /*thise molecule variable will contain onlt the smile. 
                To be used with the pubchem API and chart
                */
                let molecule = molecules[1];
                let message = {
                    mol: molecules
                }

                $.post("http://127.0.0.1:5000/predict", JSON.stringify(message), function (response) {
                    let predictions = Object.entries(response.prediction).map(function (entry) {
                        return {
                            category: excipients,
                            value: entry
                        };
                    });



                    //    console.log(predictions);
                    var solubilities = [];
                    var solubilitiesAndExcipients = [];
                    let sols = response.prediction[0];
                    var i = 0;
                    console.log(sols);
                    sols.forEach(function (element) {
                        //this model will not use logS for solubility but mg/ml 
                        solubility = element.toFixed(4);
                        console.log(solubility);
                        //assign the group based on its index location
                        let group = ''
                        if (i < 9) {
                            group = 'Aqueous';
                        }
                        else if (i < 15) {
                            group = 'Surfactants';
                        }
                        else {
                            group = "Solvents";
                        }
                        solubilities.push(solubility);
                        //this array will be used for the dataTable, has headers : [index excipient solubility group ] 
                        solubilitiesAndExcipients.push(
                            [i, excipients[i], solubility, group]);
                        i++;
                    });
                    
                    
                    // set name up to be passed to header of chartjs
                    let name = response['name']
                    console.log(name);


                    /*set up the arrays to be passed into chartjs
                    */
                   
                    let aqueous = new Array(solubilities.length);
                    let surfactants = new Array(solubilities.length);
                    let solvents = new Array(solubilities.length);
                    // let surfactants = solubilities.slice(9, 15);
                    //let solvents = solubilities.slice(15, 23);
                    for (i = 0; i < solubilities.length; i++) {
                        if (i < 9) {
                            aqueous[i] = solubilities[i];
                            surfactants[i] = 0;
                            solvents[i] = 0;
                        }
                        else if (i < 15) {
                            surfactants[i] = solubilities[i];
                            solvents[i] = 0;
                            aqueous[i] = 0;
                        }
                        else {
                            solvents[i] = solubilities[i];
                            aqueous[i] = 0;
                            surfactants[i] = 0;
                        }
                    }

                    let solChart = document.getElementById('row-chart-e').getContext('2d');
                    var solubiltyChart = new Chart(solChart, {
                        type: 'bar',
                        data: {
                            labels: excipients,
                            datasets: [{
                                label: 'Aqueous Excipients',
                                data: aqueous,
                                backgroundColor: '#45aaf2',
                                borderWidth: 1.5,
                                hoverBorderWidth: 3,
                                hoverBorderColor: '#4b6584'
                            },
                            {
                                label: 'Surfactants',
                                data: surfactants,
                                backgroundColor: '#b8a9c9',
                                borderWidth: 1.5,
                                hoverBorderWidth: 3,
                            },
                            {
                                label: 'Solvents',
                                data: solvents,
                                backgroundColor: '#667292',
                                borderWidth: 1.5,
                                hoverBorderWidth: 3,
                            }]
                        },
                        options: {
                            title: {
                                display: true,
                                text: 'Solubility of ' + name,
                                fontSize: 25,
                                gridLines: {
                                    display:true,
                                    drawTicks: true,
                                    
                                }
                            },
                            legend: {
                                position: 'top',
                            },
                            scales: {
                                yAxes: [{
                                    ticks: {
                                        beginAtZero: true,
                                        color:'#5B2C6F'
                                    }
                                }],
                                xAxes: [{
                                    display: true,
                                    ticks: {
                                        autoSkip: false,
                                        color:'#5B2C6F'
                                    }

                                }]
                            }
                        }
                    });
                    //set up the table with solubilities
                    $(document).ready(function () {
                        $("#chartE").clear();
                        $("#chartE").destroy();
                        $("chartE").empty();
                        $('#chartE').DataTable({
                            data: solubilitiesAndExcipients,
                            columns: [
                                { title: 'Index' },
                                { title: "Excipient" },
                                { title: "Solubility" },
                                { title: "Group" }
                            ]
                        });
                    });
                });
            });                
    </script>
</body>

</html>